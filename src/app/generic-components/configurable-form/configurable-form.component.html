@if (structure(); as structureData) {
    <div class="w-full max-w-6xl mx-auto overflow-hidden configurable-form-container" [class]="structureData.styleClass || ''">
        <!-- Form Header -->
        <div class="px-6 py-8 configurable-form-header">
            <div class="flex flex-col items-center gap-2 configurable-form-header-content">
                @if (structureData.imgUrl) {
                    <img [src]="structureData.imgUrl" alt="Form Icon" class="w-[350px] h-auto rounded-full" />
                }
                <h2 class="text-2xl sm:text-3xl font-bold configurable-form-title self-center">{{ structureData.name }}</h2>
                @if (structureData.description) {
                    <p class="mt-4 text-4xl leading-relaxed configurable-form-description">{{ structureData.description }}</p>
                }
            </div>
        </div>

        <!-- Form Content -->
        <div class="p-6 configurable-form-body">
            <form [formGroup]="form()" (ngSubmit)="onSubmit()">
                <!-- Global validation errors -->
                @if (hasGlobalValidationErrors()) {
                    <div class="global-validation-errors">
                        <p class="error-message">Erreurs de validation globales :</p>
                        <ul>
                            @for (error of getGlobalValidationErrors(); track $index) {
                                <li class="error-item">{{ error }}</li>
                            }
                        </ul>
                    </div>
                }

                <!-- Unified form elements (fields and groups in order) -->
                @for (element of sortedFormElements(); track trackByElementId($index, element)) {
                    <!-- Handle individual fields -->
                    @if (isFormField(element)) {
                        <div class="form-field">
                            <label [for]="element.name" class="form-label">
                                {{ element.label }}
                                @if (element.required) {
                                    <span class="required-asterisk">*</span>
                                }
                            </label>

                            <!-- Handle different field types -->
                            @switch (element.type) {
                                @case ('text') {
                                    <input pInputText [id]="element.name" [formControlName]="element.name" [placeholder]="element.placeholder" [disabled]="element.disabled || false" class="form-input" />
                                }
                                @case ('email') {
                                    <input pInputText type="email" [id]="element.name" [formControlName]="element.name" [placeholder]="element.placeholder" [disabled]="element.disabled || false" class="form-input" />
                                }
                                @case ('password') {
                                    <input pInputText type="password" [id]="element.name" [formControlName]="element.name" [placeholder]="element.placeholder" [disabled]="element.disabled || false" class="form-input" />
                                }
                                @case ('number') {
                                    <p-inputNumber [id]="element.name" [formControlName]="element.name" [placeholder]="element.placeholder" [disabled]="element.disabled || false" class="form-input" />
                                }
                                @case ('date') {
                                    <p-datePicker [id]="element.name" [formControlName]="element.name" [placeholder]="element.placeholder" [disabled]="element.disabled || false" class="form-input" />
                                }
                                @case ('textarea') {
                                    <textarea pTextarea [id]="element.name" [formControlName]="element.name" [placeholder]="element.placeholder" [disabled]="element.disabled || false" class="form-input"></textarea>
                                }
                                @case ('select') {
                                    <p-select
                                        [id]="element.name"
                                        [formControlName]="element.name"
                                        [options]="getSelectOptions(element)"
                                        [placeholder]="element.placeholder"
                                        [disabled]="element.disabled || false"
                                        [optionLabel]="element.displayKey || 'label'"
                                        [optionValue]="element.compareKey || 'value'"
                                        class="form-input"
                                    />
                                }
                                @case ('multiselect') {
                                    <p-multiSelect
                                        [id]="element.name"
                                        [formControlName]="element.name"
                                        [options]="getSelectOptions(element)"
                                        [placeholder]="element.placeholder"
                                        [disabled]="element.disabled || false"
                                        [optionLabel]="element.displayKey || 'label'"
                                        [optionValue]="element.compareKey || 'value'"
                                        class="form-input"
                                    />
                                }
                                @case ('checkbox') {
                                    <div class="checkbox-wrapper">
                                        <p-checkbox [id]="element.name" [formControlName]="element.name" [disabled]="element.disabled || false" [binary]="true" />
                                        <label [for]="element.name" class="checkbox-label">{{ element.label }}</label>
                                    </div>
                                }
                                @case ('radio') {
                                    <div class="radio-group">
                                        @for (option of element.options || []; track option) {
                                            <div class="radio-option">
                                                <p-radioButton [id]="element.name + '_' + getOptionValue(option, element)" [formControlName]="element.name" [value]="getOptionValue(option, element)" [disabled]="element.disabled || false" />
                                                <label [for]="element.name + '_' + getOptionValue(option, element)" class="radio-label">
                                                    {{ getOptionLabel(option, element) }}
                                                </label>
                                            </div>
                                        }
                                    </div>
                                }
                                @case ('color') {
                                    <p-colorPicker [id]="element.name" [formControlName]="element.name" [disabled]="element.disabled || false" class="form-input" />
                                }
                            }

                            <!-- Field validation error -->
                            @if (isDirectFieldInvalid(element.name)) {
                                <small class="error-message">{{ getDirectFieldError(element.name) }}</small>
                            }
                        </div>
                    }

                    <!-- Handle form field groups -->
                    @if (isFormFieldGroup(element)) {
                        <div class="form-section" [formGroupName]="element.id">
                            <!-- Group header -->
                            <div class="form-section-header">
                                <h3 class="section-title">{{ element.label }}</h3>
                                @if (element.description) {
                                    <p class="section-description">{{ element.description }}</p>
                                }
                            </div>

                            <!-- Group validation errors -->
                            @if (hasGroupValidationErrors(element.id)) {
                                <div class="group-validation-errors">
                                    <p class="error-message">Erreurs de validation pour cette section :</p>
                                    <ul>
                                        @for (error of getGroupValidationErrors(element.id); track $index) {
                                            <li class="error-item">{{ error }}</li>
                                        }
                                    </ul>
                                </div>
                            }

                            <!-- Fields in this group -->
                            @for (field of getSortedFieldsInGroup(element); track trackByFieldId($index, field)) {
                                <div class="form-field">
                                    <label [for]="field.name" class="form-label">
                                        {{ field.label }}
                                        @if (field.required) {
                                            <span class="required-asterisk">*</span>
                                        }
                                    </label>

                                    <!-- Handle different field types -->
                                    @switch (field.type) {
                                        @case ('text') {
                                            <input pInputText [id]="field.name" [formControlName]="field.name" [placeholder]="field.placeholder" [disabled]="field.disabled || false" class="form-input" />
                                        }
                                        @case ('email') {
                                            <input pInputText type="email" [id]="field.name" [formControlName]="field.name" [placeholder]="field.placeholder" [disabled]="field.disabled || false" class="form-input" />
                                        }
                                        @case ('password') {
                                            <input pInputText type="password" [id]="field.name" [formControlName]="field.name" [placeholder]="field.placeholder" [disabled]="field.disabled || false" class="form-input" />
                                        }
                                        @case ('number') {
                                            <p-inputNumber [id]="field.name" [formControlName]="field.name" [placeholder]="field.placeholder" [disabled]="field.disabled || false" class="form-input" />
                                        }
                                        @case ('date') {
                                            <p-datePicker [id]="field.name" [formControlName]="field.name" [placeholder]="field.placeholder" [disabled]="field.disabled || false" class="form-input" />
                                        }
                                        @case ('textarea') {
                                            <textarea pTextarea [id]="field.name" [formControlName]="field.name" [placeholder]="field.placeholder" [disabled]="field.disabled || false" class="form-input"></textarea>
                                        }
                                        @case ('select') {
                                            <p-select
                                                [id]="field.name"
                                                [formControlName]="field.name"
                                                [options]="getSelectOptions(field)"
                                                [placeholder]="field.placeholder"
                                                [disabled]="field.disabled || false"
                                                [optionLabel]="field.displayKey || 'label'"
                                                [optionValue]="field.compareKey || 'value'"
                                                class="form-input"
                                            />
                                        }
                                        @case ('multiselect') {
                                            <p-multiSelect
                                                [id]="field.name"
                                                [formControlName]="field.name"
                                                [options]="getSelectOptions(field)"
                                                [placeholder]="field.placeholder"
                                                [disabled]="field.disabled || false"
                                                [optionLabel]="field.displayKey || 'label'"
                                                [optionValue]="field.compareKey || 'value'"
                                                class="form-input"
                                            />
                                        }
                                        @case ('checkbox') {
                                            <div class="checkbox-wrapper">
                                                <p-checkbox [id]="field.name" [formControlName]="field.name" [disabled]="field.disabled || false" [binary]="true" />
                                                <label [for]="field.name" class="checkbox-label">{{ field.label }}</label>
                                            </div>
                                        }
                                        @case ('radio') {
                                            <div class="radio-group">
                                                @for (option of field.options || []; track option) {
                                                    <div class="radio-option">
                                                        <p-radioButton [id]="field.name + '_' + getOptionValue(option, field)" [formControlName]="field.name" [value]="getOptionValue(option, field)" [disabled]="field.disabled || false" />
                                                        <label [for]="field.name + '_' + getOptionValue(option, field)" class="radio-label">
                                                            {{ getOptionLabel(option, field) }}
                                                        </label>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        @case ('color') {
                                            <p-colorPicker [id]="field.name" [formControlName]="field.name" [disabled]="field.disabled || false" class="form-input" />
                                        }
                                    }

                                    <!-- Field validation error -->
                                    @if (isFieldInvalid(element.id, field.name)) {
                                        <small class="error-message">{{ getFieldError(element.id, field.name) }}</small>
                                    }
                                </div>
                            }
                        </div>
                    }
                }

                <!-- Form actions -->
                <div class="form-actions">
                    <button type="submit" [disabled]="!isFormValid()" class="btn btn-primary">
                        {{ structure()?.submitButtonLabel || 'Enregistrer' }}
                    </button>
                    <button type="button" (click)="onCancelClick()" class="btn btn-secondary">
                        {{ structure()?.cancelButtonLabel || 'Annuler' }}
                    </button>
                </div>
            </form>
        </div>
    </div>
} @else {
    <div class="flex items-center justify-center p-12 bg-gray-50 rounded-lg configurable-form-empty">
        <div class="text-center configurable-form-empty-content">
            <i class="pi pi-inbox text-4xl mb-4 configurable-form-empty-icon"></i>
            <p class="text-lg configurable-form-empty-message">Aucune structure de formulaire fournie</p>
        </div>
    </div>
}
